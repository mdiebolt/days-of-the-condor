<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge;chrome=1' http-equiv='X-UA-Compatible'>
    <title>Days of the Condor</title>
    <link href="http://fonts.googleapis.com/css?family=Lato:300|Libre+Baskerville" rel="stylesheet" type="text/css" />
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/blog.css" rel="stylesheet" type="text/css" />
    <link href="/images/favicon.png" rel="icon" type="image/png" />
  </head>
  <body><header m-fixed>
      <h1>
        <a href='/' m-no-underline>Days of the Condor</a>
      </h1>
      <div class='blog-information' m-top-right>
        <a class='blog-information--projects' href='https://github.com/mdiebolt'>Projects</a>
        <a class='blog-information--about' href='http://diebo.lt'>About</a>
        <div class='blog-information--recent-article-navigation'>
          <div class='blog-information--top-bar'></div>
          <div class='blog-information--middle-bar'></div>
          <div class='blog-information--bottom-bar'></div>
        </div>
      </div>
    </header><div class='blog-page'>
      <div class='blog-page--container'>
        <div class='blog-page--post'>
          <h2 class='title'>
            <a href="/2015/11/08/writing-your-own-coffeelint-plugin.html">Writing your own CoffeeLint plugin</a>
          </h2>
          <div class='blog-date' m-small>Nov  8, 2015</div>
          <div class='blog-date' m-fixed='' m-left=''>
            <div class='blog-date--month'>NOV</div>
            <div class='blog-date--day' m-bold> 8</div>
            <div class='blog-date--year'>2015</div>
          </div>
        </div>
        <p>Recently I wrote about maintaining code consistency on growing teams using CoffeeLint. If you use CoffeeLint across many projects or with a large enough team, sooner or later you’ll come across a situation that isn’t covered by an out of the box rule.</p>
        
        <p>CoffeeLint provides a plugin system that makes authoring your own linter easy. The implementation guidelines are outlined in <a href="http://www.coffeelint.org/">Building Custom Rules</a>. There are three different types of rules that can be implemented depending on your needs: LineLinter, TokenLinter, and ASTLinter.</p>
        
        <h3>Describing the rule</h3>
        
        <p>I’m going to write a TokenLinter that enforces whitespace conventions when invoking a function. To pass this check a function call must:</p>
        
        <ol>
        <li>Not include whitespace following the opening parenthesis.</li>
        <li>Use a space to separate each argument.</li>
        <li>Not include whitespace before the closing parenthesis.</li>
        </ol>
        
        <p><em>Note: The points about opening and closing parentheses don&rsquo;t apply if they have been omitted when calling the function.</em></p>
        <pre class="highlight coffeescript"><code><span class="c1"># Valid style&#x000A;</span><span class="nx">fn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>&#x000A;<span class="nx">fn</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span>&#x000A;<span class="nx">fn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="k">if</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">10</span>&#x000A;<span class="nx">fn</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span> <span class="k">if</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">10</span>&#x000A;<span class="nx">fn</span> <span class="mi">2</span><span class="p">,</span>&#x000A;  <span class="na">someOption</span><span class="o">:</span> <span class="no">true</span>&#x000A;&#x000A;<span class="c1"># Invalid style&#x000A;</span><span class="nx">fn</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>&#x000A;<span class="nx">fn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span> <span class="p">)</span>&#x000A;<span class="nx">fn</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span> <span class="p">)</span>&#x000A;<span class="nx">fn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>&#x000A;</code></pre>
        
        <h3>Start from an existing rule</h3>
        
        <p>Rather than write a plugin from the ground up, I searched through CoffeeLint&rsquo;s base rules and <a href="https://github.com/clutchski/coffeelint/blob/master/src/rules/no_implicit_parens.coffee">found one</a> similar to what I wanted.</p>
        
        <p>The main difference is that I wanted to check both <code>CALL_START</code> <em>and</em> <code>CALL_END</code> tokens to make sure they were not surrounded by a space. In addition, I would need to test tokens in between to make sure arguments to the function were spaced appropriately.</p>
        
        <h3>Breaking it down</h3>
        <pre class="highlight coffeescript"><code><span class="c1"># ...&#x000A;</span><span class="na">tokens</span><span class="o">:</span> <span class="p">[</span><span class="s">"CALL_START"</span><span class="p">,</span> <span class="s">"CALL_END"</span><span class="p">]</span>&#x000A;&#x000A;<span class="na">lintToken</span><span class="o">:</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">tokenApi</span><span class="p">)</span> <span class="o">-&gt;</span>&#x000A;  <span class="nx">tokenType</span> <span class="o">=</span> <span class="nx">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>&#x000A;  <span class="k">if</span> <span class="nx">tokenType</span> <span class="o">==</span> <span class="s">"CALL_START"</span>&#x000A;    <span class="nx">isOpeningParenError</span> <span class="o">=</span> <span class="no">true</span> <span class="k">if</span> <span class="nx">token</span><span class="p">.</span><span class="na">spaced</span>&#x000A;    <span class="nx">isArgumentError</span> <span class="o">=</span> <span class="nx">checkArgumentSpacing</span><span class="p">(</span><span class="nx">tokenApi</span><span class="p">)</span>&#x000A;  <span class="k">else</span> <span class="k">if</span> <span class="nx">tokenType</span> <span class="o">==</span> <span class="s">"CALL_END"</span>&#x000A;    <span class="nx">isClosingParenError</span> <span class="o">=</span> <span class="nx">checkCloseParenSpacing</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">tokenApi</span><span class="p">)</span>&#x000A;&#x000A;  <span class="nx">isOpeningParenError</span> <span class="o">||</span> <span class="nx">isArgumentError</span> <span class="o">||</span> <span class="nx">isClosingParenError</span>&#x000A;<span class="c1"># ...&#x000A;</span></code></pre>
        
        <p><code>lintToken</code> is the crux of a TokenLinter plugin. In our case it&rsquo;s called any time a <code>CALL_START</code> or <code>CALL_END</code> token is encountered. Stepping through it we see that a linting error is triggered if any of the following are true:</p>
        
        <ol>
        <li>Does the opening parenthesis incorrectly use a space?</li>
        <li>Are any of the function arguments incorrectly spaced?</li>
        <li>Does the closing parenthesis incorrectly use a space?</li>
        </ol>
        
        <h4>Opening parenthesis</h4>
        
        <p>The opening parenthesis case is easy to handle since CoffeeScript&rsquo;s compiler gives us a property <code>spaced</code> if the token has a space after it. </p>
        <pre class="highlight coffeescript"><code><span class="nx">isOpeningParenError</span> <span class="o">=</span> <span class="no">true</span> <span class="k">if</span> <span class="nx">token</span><span class="p">.</span><span class="na">spaced</span>&#x000A;</code></pre>
        
        <h4>Function arguments</h4>
        
        <p>Next, starting at <code>CALL_START</code>, we use <code>checkArgumentSpacing</code> to loop over the arguments by peeking forward until we reach <code>CALL_END</code>. At each step we need to check a few things:</p>
        
        <ol>
        <li>Is the token a comma? We care about commas because they&rsquo;re the only character used to separate arguments in JavaScript. </li>
        <li>Does the token have a space after it? This covers inline arguments.</li>
        <li>Does the token have a newline after it? This covers multiline arguments, commonly used with configuration options.</li>
        </ol>
        <pre class="highlight coffeescript"><code><span class="nx">isArgumentIncorrectlySpaced</span> <span class="o">=</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="o">-&gt;</span>&#x000A;  <span class="nx">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">","</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="na">spaced</span> <span class="o">||</span> <span class="nx">token</span><span class="p">.</span><span class="na">newLine</span><span class="p">)</span>&#x000A;&#x000A;<span class="nx">checkArgumentSpacing</span> <span class="o">=</span> <span class="p">(</span><span class="nx">tokenApi</span><span class="p">)</span> <span class="o">-&gt;</span>&#x000A;  <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span>&#x000A;  <span class="nx">insideFunctionCall</span> <span class="o">=</span> <span class="no">true</span>&#x000A;  <span class="k">while</span> <span class="nx">insideFunctionCall</span>&#x000A;    <span class="nx">nextToken</span> <span class="o">=</span> <span class="nx">tokenApi</span><span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>&#x000A;    <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span>&#x000A;&#x000A;    <span class="nx">isLintingError</span> <span class="o">=</span> <span class="no">true</span> <span class="k">if</span> <span class="nx">isArgumentIncorrectlySpaced</span><span class="p">(</span><span class="nx">nextToken</span><span class="p">)</span>&#x000A;    <span class="nx">insideFunctionCall</span> <span class="o">=</span> <span class="nx">nextToken</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"CALL_END"</span>&#x000A;&#x000A;  <span class="nx">isLintingError</span>&#x000A;</code></pre>
        
        <h4>Closing parenthesis</h4>
        
        <p>This one is trickier than the opening case because you can&rsquo;t rely on the <code>spaced</code> property since it only applies to spacing <em>after</em> the given token. You can look at the previous token&rsquo;s spacing property, but this breaks down when a function is invoked and then followed by a postfix expression. In this situation the previous token will have a space after it and look like a violation of the rule. As a workaround, I check that the current token (<code>CALL_END</code>) and the previous token are in the same position. That fact that these tokens are reported in the same position seems to be a CoffeeScript compiler quirk, but is reliable enough for our needs.</p>
        <pre class="highlight coffeescript"><code><span class="nx">checkCloseParenSpacing</span> <span class="o">=</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">tokenApi</span><span class="p">)</span> <span class="o">-&gt;</span>&#x000A;  <span class="nx">previousToken</span> <span class="o">=</span> <span class="nx">tokenApi</span><span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>&#x000A;  <span class="k">if</span> <span class="nx">previousToken</span><span class="p">.</span><span class="na">spaced</span>&#x000A;    <span class="c1"># generated means that CoffeeScript is adding parentheses for us&#x000A;</span>    <span class="c1"># and that the author has omitted them&#x000A;</span>    <span class="k">if</span> <span class="nx">token</span><span class="p">.</span><span class="na">generated</span>&#x000A;      <span class="nx">unless</span> <span class="nx">token</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="na">last_column</span> <span class="o">==</span> <span class="nx">previousToken</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="na">last_column</span>&#x000A;        <span class="nx">isLintingError</span> <span class="o">=</span> <span class="no">true</span>&#x000A;    <span class="k">else</span>&#x000A;      <span class="nx">isLintingError</span> <span class="o">=</span> <span class="no">true</span>&#x000A;&#x000A;  <span class="nx">isLintingError</span>&#x000A;</code></pre>
        
        <h3>Wrapping up</h3>
        
        <p>Writing one of these plugins doesn&rsquo;t take much time and it&rsquo;ll save you the headache of fighting with developers with strong opposing opinions. Now go out and write all the plugins to bend the code style of your organization to your will!</p>
        <div class='blog-social-media'>
          <a class='fa fa-3x fa-twitter blog-social-media--twitter' href='https://twitter.com/mdiebolt' m-no-underline></a>
          <a class='fa fa-3x fa-github blog-social-media--github' href='https://github.com/mdiebolt' m-no-underline></a>
        </div>
      </div>
    </div><nav class='blog-previous-posts' m-fixed-right>
      <div class='blog-previous-posts--container'>
        <img class="blog-logo" src="/images/logo.svg" />
        <h2 class='blog-previous-posts--title'>Articles</h2>
        <ul class='blog-previous-posts--list'>
          <li class='blog-previous-posts--article'>
            <a href='/2015/11/08/writing-your-own-coffeelint-plugin.html'>Writing your own CoffeeLint plugin</a>
            <div class='date'>Nov  8, 2015</div>
          </li>
          <li class='blog-previous-posts--article'>
            <a href='/2015/10/08/using-coffeelint-for-consistency.html'>Using CoffeeLint for consistent code</a>
            <div class='date'>Oct  8, 2015</div>
          </li>
          <li class='blog-previous-posts--article'>
            <a href='/2015/10/04/How-to-build-a-living-styleguide.html'>How to build a living styleguide</a>
            <div class='date'>Oct  4, 2015</div>
          </li>
          <li class='blog-previous-posts--article'>
            <a href='/2015/09/30/dead-simple-github-page-publishing.html'>Dead simple GitHub Page publishing</a>
            <div class='date'>Sep 30, 2015</div>
          </li>
          <li class='blog-previous-posts--article'>
            <a href='/2012/12/16/coffeescript-static-analysis.html'>CoffeeScript static analysis</a>
            <div class='date'>Dec 16, 2012</div>
          </li>
          <li class='blog-previous-posts--article'>
            <a href='/2012/12/10/clean-bash-profiles.html'>Clean bash profiles</a>
            <div class='date'>Dec 10, 2012</div>
          </li>
          <li class='blog-previous-posts--article'>
            <a href='/2011/10/05/Programmatically focus content inside an iFrame.html'>Programmatically focus content inside an iFrame</a>
            <div class='date'>Oct  5, 2011</div>
          </li>
          <li class='blog-previous-posts--article'>
            <a href='/2011/09/20/jQuery-UI-Draggable-stop-drag-programmatically.html'>jQuery UI Draggable stop drag programmatically</a>
            <div class='date'>Sep 20, 2011</div>
          </li>
          <li class='blog-previous-posts--article'>
            <a href='/2011/09/15/Arrays-and-jQuery-data-attributes.html'>Arrays and jQuery data attributes</a>
            <div class='date'>Sep 15, 2011</div>
          </li>
          <li class='blog-previous-posts--article'>
            <a href='/2011/03/17/OS-X-dock-in-css.html'>OS X dock in css</a>
            <div class='date'>Mar 17, 2011</div>
          </li>
        </ul>
      </div>
    </nav>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-20149612-1', 'auto');
      ga('send', 'pageview');
    </script>
    <script src="/javascripts/site.js" type="text/javascript"></script>
  </body>
</html>
